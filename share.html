<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <link rel="stylesheet" href="share.css" />
    <title>share</title>

    <script src="https://www.gstatic.com/firebasejs/8.0.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.0.0/firebase-analytics.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.0.0/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.0.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.0.0/firebase-storage.js"></script>

    <script>
      const firebaseConfig = {
        apiKey: "AIzaSyCmiBcZ3VCgEAtDMgyg0vDFhNyi7H2xcpk",
        authDomain: "seasonal-lens.firebaseapp.com",
        databaseURL: "https://seasonal-lens-default-rtdb.firebaseio.com",
        projectId: "seasonal-lens",
        storageBucket: "seasonal-lens.appspot.com",
        messagingSenderId: "961849470376",
        appId: "1:961849470376:web:cfa47d3a40d59a1116c19d",
      };
      firebase.initializeApp(firebaseConfig);
    </script>
  </head>
  <body>
    <!-- ãƒãƒ³ãƒãƒ¼ã‚¬ãƒ¼ãƒ¡ãƒ‹ãƒ¥ãƒ¼éƒ¨åˆ† -->
    <div class="nav">
      <!-- ãƒãƒ³ãƒãƒ¼ã‚¬ãƒ¼ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®è¡¨ç¤ºãƒ»éè¡¨ç¤ºã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ -->
      <input id="drawer_input" class="drawer_hidden" type="checkbox" />

      <!-- ãƒãƒ³ãƒãƒ¼ã‚¬ãƒ¼ã‚¢ã‚¤ã‚³ãƒ³ -->
      <label for="drawer_input" class="drawer_open"><span></span></label>

      <!-- ãƒ¡ãƒ‹ãƒ¥ãƒ¼ -->
      <nav class="nav_content">
        <ul class="nav_list">
          <li class="nav_item"><a href="home.html">Home</a></li>
          <li class="nav_item"><a href="posts.html">Posts</a></li>
        </ul>
      </nav>
    </div>

    <div class="container">
      <h1>Share</h1>
      <label class="upload-label">
        å†™çœŸã‚’é¸æŠ
        <input type="file" id="postPic" accept="image/*" required />
      </label>
      <form id="postForm">
        <!-- <input type="file" id="postPic" accept="image/*" required /> -->

        <input type="text" id="caption" placeholder="caption" />

        <div class="feelings-container">
          <input
            type="radio"
            id="happy"
            value="happy"
            name="feelings"
            data-feeling="100"
            class="feel"
            required
          />
          <label for="happy" class="feel-label">ğŸ˜</label>
          <input
            type="radio"
            id="relax"
            value="relax"
            data-feeling="50"
            name="feelings"
            class="feel"
          />
          <label for="relax" class="feel-label">ğŸ˜Œ</label>
          <input
            type="radio"
            id="mad"
            value="mad"
            data-feeling="10"
            name="feelings"
            class="feel"
          />
          <label for="mad" class="feel-label">ğŸ˜¡</label>
          <input
            type="radio"
            id="crying"
            value="crying"
            data-feeling="5"
            name="feelings"
            class="feel"
          />
          <label for="crying" class="feel-label">ğŸ˜­</label>
          <input
            type="radio"
            id="surprised"
            value="surprised"
            data-feeling="60"
            name="feelings"
            class="feel"
          />
          <label for="surprised" class="feel-label">ğŸ¤¯</label>
          <input
            type="radio"
            id="love"
            value="love"
            data-feeling="80"
            name="feelings"
            class="feel"
          />
          <label for="love" class="feel-label">ğŸ¥°</label>
        </div>
      </form>
      <div class="submit-button">
        <button id="submit" type="submit">Share</button>
      </div>
    </div>
  </body>
  <script>
    const db = firebase.firestore();
    const form = document.getElementById("postForm");
    const button = document.getElementById("submit");

    button.addEventListener("click", function (event) {
      //event.preventDefault();
      console.log("click");
      let today = new Date();
      const postDate = today.getFullYear() + "/" + (today.getMonth()+1) + "/" + today.getDate() + "  " + today.getHours() + ":" + today.getMinutes();

      const user = firebase.auth().currentUser;
      if (user) {
        // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡å‹•ä½œã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«

        const picture = document.getElementById("postPic").files[0];
        const caption = document.getElementById("caption").value;
        const feelformData = new FormData(form);
        const feelData = feelformData.get("feelings");

        // ç”»åƒã‚’Firebase Storageã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã€URLã‚’å–å¾—
        const storageRef = firebase.storage().ref();

        const postPictRef = storageRef.child(
          "postPictures/" + user.uid + "/" + picture.name
        );
        postPictRef
          .put(picture)
          .then(function (snapshot) {
            // ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ãŸç”»åƒã®URLã‚’å–å¾—
            postPictRef.getDownloadURL().then(function (url) {
              // Firestoreã«ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã¨å…±ã«ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
              //user.uid
              db.collection("PostData")
                .doc(user.uid)
                .collection("post")
                .add({
                  Picture: url,
                  caption: caption,
                  feeling: feelData,
                  postDate: postDate
                })
                .then(function () {
                  console.log("Document successfully written!");
                  alert("post success!");
                  form.reset();
                  //window.location.href = "home.html";
                })
                .catch(function (error) {
                  console.error("Error writing document: ", error);
                  alert("Failed to save post.");
                });
            });
          })
          .catch(function (error) {
            console.error("Error uploading file: ", error);
            alert("Failed to upload picture.");
          });
      } else {
        console.log("User is not signed in.");
        alert("æŠ•ç¨¿ã«ã¯ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™");
      }
    });
  </script>
</html>
