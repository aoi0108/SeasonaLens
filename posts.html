<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <link rel="stylesheet" href="posts.css" />
    <link
      rel="stylesheet"
      href="https://unpkg.com/@vectopus/atlas-icons/style.css"
    />
    <title>Posts</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.0.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.0.0/firebase-analytics.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.0.0/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.0.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.0.0/firebase-storage.js"></script>
    <script>
      const firebaseConfig = {
        apiKey: "AIzaSyCmiBcZ3VCgEAtDMgyg0vDFhNyi7H2xcpk",
        authDomain: "seasonal-lens.firebaseapp.com",
        databaseURL: "https://seasonal-lens-default-rtdb.firebaseio.com",
        projectId: "seasonal-lens",
        storageBucket: "seasonal-lens.appspot.com",
        messagingSenderId: "961849470376",
        appId: "1:961849470376:web:cfa47d3a40d59a1116c19d",
      };
      firebase.initializeApp(firebaseConfig);
    </script>
  </head>
  <body>
    <!-- ハンバーガーメニュー部分 -->
    <div class="nav">
      <!-- ハンバーガーメニューの表示・非表示を切り替えるチェックボックス -->
      <input id="drawer_input" class="drawer_hidden" type="checkbox" />

      <!-- ハンバーガーアイコン -->
      <label for="drawer_input" class="drawer_open"><span></span></label>

      <!-- メニュー -->
      <nav class="nav_content">
        <ul class="nav_list">
          <li class="nav_item"><a href="home.html">Home</a></li>
          <li class="nav_item"><a href="share.html">Share</a></li>
        </ul>
      </nav>
    </div>
    <!-- 本文 -->
    <div class="PicContainer">
      <botton type="button"
        ><img src="images/arrow-left-circle.svg" alt="previous post"
      /></botton>
      <botton type="button"
        ><img src="images/arrow-right-circle.svg" onclick="test()"
      /></botton>
    </div>
    <!-- グラフ -->
    <canvas id="updateChart"></canvas>
    <div class="update-button">
      <button id="updateButton">データ更新</button>
    </div>
    <script>
      let myUpdateChart; // グローバルスコープで変数を宣言
      // キャンバスの要素を取得
      const db = firebase.firestore();
      const ctx = document.getElementById("updateChart").getContext("2d");
      const updateButton = document.getElementById("updateButton");
      // グラフデータ取得関数
      function getGraphData() {
        return db
          .collection("PostData")
          .doc("testid")
          .collection("post")
          .orderBy("timestamp", "asc") // タイムスタンプの昇順で取得
          .get()
          .then((snapshot) => {
            const data = [];
            const labels = [];
            snapshot.forEach((doc) => {
              const docData = doc.data();
              // データから感情の数値を取得して配列に追加
              data.push(docData.feelData);
              labels.push(docData.postDate);
            });
            return { data, labels };
          })
          .catch((error) => {
            console.error("Error getting documents: ", error);
            return { data: [], labels: [] }; // エラー時は空の配列を返す
          });
      }

      // グラフ作成関数
      async function createChart() {
        const { data, labels } = await getGraphData();
        // 既存のグラフがあれば破棄する
        if (myUpdateChart) {
          myUpdateChart.destroy();
        }
        myUpdateChart = new Chart(ctx, {
          type: "line",
          data: {
            // データの設定
            labels: Array.from({ length: data.length }, (_, i) => i + 1), // ラベルは投稿の順番
            datasets: [
              {
                label: "Feelings Transition",
                data: data, // Firestoreから取得したデータをセット
                // グラフの設定
                fill: false,
                borderColor: "#c88baa",
                tension: 0.1,
              },
            ],
          },
          options: {
            // オプションの設定
            scales: {
              x: {
                type: "linear",
                position: "bottom",
                title: {
                  display: true,
                  text: "Date",
                },
              },
              y: {
                min: 1,
                max: 6,
                ticks: {
                  callback: function (value, index, values) {
                    // 感情の数値からラベルを取得
                    return [
                      "Crying",
                      "Mad",
                      "Surprised",
                      "Relax",
                      "Love",
                      "Happy",
                    ][value - 1];
                  },
                },
                title: {
                  display: true,
                  text: "Feeling",
                },
              },
            },
          },
        });
      }

      // 初期化
      createChart();

      // データ更新ボタンクリック時の処理
      updateButton.addEventListener("click", async () => {
        // グラフ再作成
        await createChart();
      });

      function test() {
        let today = new Date();
        console.log(today);
        const postDate =
          today.getFullYear() +
          "/" +
          (today.getMonth() + 1) +
          "/" +
          today.getDate() +
          "  " +
          today.getHours() +
          ":" +
          today.getMinutes();
        console.log(postDate);
      }
    </script>
  </body>
</html>
