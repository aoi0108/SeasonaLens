<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <link rel="stylesheet" href="posts.css" />
    <link
      rel="stylesheet"
      href="https://unpkg.com/@vectopus/atlas-icons/style.css"
    />
    <title>Posts</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.0.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.0.0/firebase-analytics.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.0.0/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.0.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.0.0/firebase-storage.js"></script>
    <script>
      const firebaseConfig = {
        apiKey: "AIzaSyCmiBcZ3VCgEAtDMgyg0vDFhNyi7H2xcpk",
        authDomain: "seasonal-lens.firebaseapp.com",
        databaseURL: "https://seasonal-lens-default-rtdb.firebaseio.com",
        projectId: "seasonal-lens",
        storageBucket: "seasonal-lens.appspot.com",
        messagingSenderId: "961849470376",
        appId: "1:961849470376:web:cfa47d3a40d59a1116c19d",
      };
      firebase.initializeApp(firebaseConfig);
    </script>
  </head>
  <body>
    <!-- ãƒãƒ³ãƒãƒ¼ã‚¬ãƒ¼ãƒ¡ãƒ‹ãƒ¥ãƒ¼éƒ¨åˆ† -->
    <div class="nav">
      <!-- ãƒãƒ³ãƒãƒ¼ã‚¬ãƒ¼ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®è¡¨ç¤ºãƒ»éžè¡¨ç¤ºã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ -->
      <input id="drawer_input" class="drawer_hidden" type="checkbox" />

      <!-- ãƒãƒ³ãƒãƒ¼ã‚¬ãƒ¼ã‚¢ã‚¤ã‚³ãƒ³ -->
      <label for="drawer_input" class="drawer_open"><span></span></label>

      <!-- ãƒ¡ãƒ‹ãƒ¥ãƒ¼ -->
      <nav class="nav_content">
        <ul class="nav_list">
          <li class="nav_item"><a href="home.html">Home</a></li>
          <li class="nav_item"><a href="share.html">Share</a></li>
        </ul>
      </nav>
    </div>
    <!-- æœ¬æ–‡ -->
    <div class="PostAndArrowContainer">
      <!--ã²ã ã‚ŠçŸ¢å°ï¼ˆæˆ»ã‚‹ï¼‰-->
      <botton type="button" id="leftArrow"><img src="images/arrow-left-circle.svg"  alt="previous post" ></botton>

       <div class="postContainer">
        <p id="postDay"></p>
        <img id="postPic" src="" style="height:400px;">
        <p id="feel"></p>
        <p id="caption"></p>

       </div>     
       <!--ã¿ãŽçŸ¢å°ï¼ˆé€²ã‚€ï¼‰--> 
       <botton type="button" id="rightArrow"><img src="images/arrow-right-circle.svg"></botton>
      </div>


    </div>
 
  <canvas id="lineChart"></canvas>
  <script>
    //ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®å‚ç…§ã‚’ç”¨æ„
    const db = firebase.firestore();
    
    //ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æŠ•ç¨¿ãƒ‡ãƒ¼ã‚¿ã™ã¹ã¦ã‚’åŽå®¹ã™ã‚‹é…åˆ—
    let postDatas = [];
    let i = 0;

    //ãƒœã‚¿ãƒ³ã‚’å–å¾—
    const LButton = document.getElementById("leftArrow");
    const RButton = document.getElementById("rightArrow");

    firebase.auth().onAuthStateChanged(user => {
      if(user){
        //æŠ•ç¨¿ãƒ‡ãƒ¼ã‚¿ã®å–å¾—
        db.collection("PostData").doc(user.uid).collection("post").get().then((snapShot) => {
          snapShot.forEach(doc => {
            postDatas[i] =  doc.data();
            i++;
          });
          console.log(postDatas);

          //ã‚°ãƒ©ãƒ•ã‚’æç”»ã™ã‚‹
          drawGraph();
          
          //åˆ‡ã‚Šæ›¿ãˆç”¨ã®å¤‰æ•°
          let j = 0;
          displayPost(j);

          LButton.addEventListener('click',(event)=>{
            if(j-1<0){
              j=postDatas.length-1;
            }else{
              j--;
            }
            console.log("display:"+j);
            displayPost(j);
          })

          RButton.addEventListener('click',(event)=>{
            if(j+1 > postDatas.length-1){
              j=0;
            }else{
              j++;
            }
            //console.log("display:"+j);
            displayPost(j);
          })

        });
        
        }else{
          console.log("please login.")
      }
    });

    //å—ã‘å–ã£ãŸæ•°å­—ã‚’ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã¨ã—ã¦ã€å¯¾å¿œã™ã‚‹æŠ•ç¨¿ã‚’è¡¨ç¤ºã™ã‚‹é–¢æ•°
    function displayPost(i){
      //æŠ•ç¨¿ã®è¡¨ç¤º-å†™çœŸã¨ã‚­ãƒ£ãƒ—ã‚·ãƒ§ãƒ³
      let img = new Image();
      img.onload = function() {
      document.getElementById("postPic").src = postDatas[i].Picture;
          document.getElementById("caption").innerHTML = postDatas[i].caption;

          ////æŠ•ç¨¿ã®è¡¨ç¤º-çµµæ–‡å­—
          if(postDatas[i].feeling=="happy"){
            document.getElementById("feel").innerHTML = "ðŸ˜"
          }else if(postDatas[i].feeling=="relax"){
            document.getElementById("feel").innerHTML = "ðŸ˜Œ"
          }else if(postDatas[i].feeling=="mad"){
            document.getElementById("feel").innerHTML = "ðŸ˜¡"
          }else if(postDatas[i].feeling=="crying"){
            document.getElementById("feel").innerHTML = "ðŸ˜­"
          }else if(postDatas[i].feeling=="surprised"){
            document.getElementById("feel").innerHTML = "ðŸ¤¯"
          }else if(postDatas[i].feeling=="love"){
            document.getElementById("feel").innerHTML = "ðŸ¥°"
          }
          //æŠ•ç¨¿ã®è¡¨ç¤º-æŠ•ç¨¿æ—¥
          document.getElementById("postDay").innerHTML = postDatas[i].postDate;
        };
        img.src = postDatas[i].Picture;
    }


    function drawGraph(i){
    const ctx = document.getElementById('lineChart').getContext('2d');
    let sortedPosts = postDatas.slice().sort((a, b) => new Date(a.postDate) - new Date(b.postDate)); // æ—¥ä»˜é †ã«æŠ•ç¨¿ãƒ‡ãƒ¼ã‚¿ã‚’ã‚½ãƒ¼ãƒˆ
    const postDates =  sortedPosts.map(post => post.postDate); // æŠ•ç¨¿æ—¥ã®é…åˆ—ã‚’å–å¾—
    const feelings = sortedPosts.map(post => {
    if (post.feeling == "happy") {
      return 100;
    } else if (post.feeling == "relax") {
      return 60;
    } else if (post.feeling == "mad") {
      return 10;
    } else if (post.feeling == "crying") {
      return 0;
    } else if (post.feeling == "surprised") {
      return 50;
    } else if (post.feeling == "love") {
      return 80;
    }
  });

    const myLineChart = new Chart(ctx, {
      type: 'line', // ã‚°ãƒ©ãƒ•ã®ç¨®é¡žã‚’æŒ‡å®š
      data: {
        labels: postDates,
        datasets: [{
          label: 'Change of Feelings',
          data: feelings,
          borderColor: '#c88baa',
          tension: 0.1 // æŠ˜ã‚Œç·šã®ã‚«ãƒ¼ãƒ–çŽ‡ã‚’æŒ‡å®š
          
        }]
      },
      options: {
        scales: {
         
          y: {
            beginAtZero: true
          }
        }
      }
    });
  }

  document.getElementById('logout').addEventListener('click', function(event) {
            event.preventDefault();
            firebase.auth().signOut().then(() => {
                console.log('User signed out.');
                alert("ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸ");
                window.location.href = 'home.html';
            }).catch((error) => {
                console.error('Sign Out Error', error);
            });
        });


   
  </script>
  </body>
</html>
