<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <link rel="stylesheet" href="posts.css" />
    <link
      rel="stylesheet"
      href="https://unpkg.com/@vectopus/atlas-icons/style.css"
    />
    <title>Posts</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.0.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.0.0/firebase-analytics.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.0.0/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.0.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.0.0/firebase-storage.js"></script>
    <script>
      const firebaseConfig = {
        apiKey: "AIzaSyCmiBcZ3VCgEAtDMgyg0vDFhNyi7H2xcpk",
        authDomain: "seasonal-lens.firebaseapp.com",
        databaseURL: "https://seasonal-lens-default-rtdb.firebaseio.com",
        projectId: "seasonal-lens",
        storageBucket: "seasonal-lens.appspot.com",
        messagingSenderId: "961849470376",
        appId: "1:961849470376:web:cfa47d3a40d59a1116c19d",
      };
      firebase.initializeApp(firebaseConfig);
    </script>
  </head>
  <body>
    <!-- „Éè„É≥„Éê„Éº„Ç¨„Éº„É°„Éã„É•„ÉºÈÉ®ÂàÜ -->
    <div class="nav">
      <!-- „Éè„É≥„Éê„Éº„Ç¨„Éº„É°„Éã„É•„Éº„ÅÆË°®Á§∫„ÉªÈùûË°®Á§∫„ÇíÂàá„ÇäÊõø„Åà„Çã„ÉÅ„Çß„ÉÉ„ÇØ„Éú„ÉÉ„ÇØ„Çπ -->
      <input id="drawer_input" class="drawer_hidden" type="checkbox" />

      <!-- „Éè„É≥„Éê„Éº„Ç¨„Éº„Ç¢„Ç§„Ç≥„É≥ -->
      <label for="drawer_input" class="drawer_open"><span></span></label>

      <!-- „É°„Éã„É•„Éº -->
      <nav class="nav_content">
        <ul class="nav_list">
          <li class="nav_item"><a href="home.html">Home</a></li>
          <li class="nav_item"><a href="share.html">Share</a></li>
        </ul>
      </nav>
    </div>
    <!-- Êú¨Êñá -->
    <div class="PostAndArrowContainer">
      <botton type="button"><img src="images/arrow-left-circle.svg"  alt="previous post" ></botton>

       <div class="postContainer">
        <img id="postPic" src="" style="height:300px;">
        <h3 id="caption"></h3>
        <h3 id="feel"></h3>
        <h3 id="postDay"></h3>

       </div>      
       <botton type="button"><img src="images/arrow-right-circle.svg" onclick="test()"></botton>
      </div>
      <!-- „Ç∞„É©„Éï -->
      <canvas id="updateChart"></canvas>
      <div class="update-button">
        <button id="updateButton">„Éá„Éº„ÇøÊõ¥Êñ∞</button>
      </div>

    </div>
  </body>
  <script>
  
    const db = firebase.firestore();
    //const user = firebase.auth().currentUser;

    let postDatas = [];
    let i = 0;

    firebase.auth().onAuthStateChanged(user => {
      if(user){
        db.collection("PostData").doc(user.uid).collection("post").get().then((snapShot) => {
          snapShot.forEach(doc => {
            postDatas[i] = doc.data();
            i++;
          });
          console.log(postDatas);
          
          document.getElementById("postPic").src = postDatas[0].Picture;
          document.getElementById("caption").innerHTML = postDatas[0].caption;

          if(postDatas[0].feeling=="happy"){
            document.getElementById("feel").innerHTML = "üòÅ"
          }else if(postDatas[0].feeling=="relax"){
            document.getElementById("feel").innerHTML = "üòå"
          }else if(postDatas[0].feeling=="mad"){
            document.getElementById("feel").innerHTML = "üò°"
          }else if(postDatas[0].feeling=="crying"){
            document.getElementById("feel").innerHTML = "üò≠"
          }else if(postDatas[0].feeling=="surprised"){
            document.getElementById("feel").innerHTML = "ü§Ø"
          }else if(postDatas[0].feeling=="love"){
            document.getElementById("feel").innerHTML = "ü•∞"
          }

          document.getElementById("postDay").innerHTML = postDatas[0].postDate;

        });
        
        }else{
          console.log("please login.")
      }
    });

    let myUpdateChart; // „Ç∞„É≠„Éº„Éê„É´„Çπ„Ç≥„Éº„Éó„ÅßÂ§âÊï∞„ÇíÂÆ£Ë®Ä
      // „Ç≠„É£„É≥„Éê„Çπ„ÅÆË¶ÅÁ¥†„ÇíÂèñÂæó
      const ctx = document.getElementById("updateChart").getContext("2d");
      const updateButton = document.getElementById("updateButton");
      // „Ç∞„É©„Éï„Éá„Éº„ÇøÂèñÂæóÈñ¢Êï∞
      function getGraphData() {
        return db
          .collection("PostData")
          .doc("testid")
          .collection("post")
          .orderBy("timestamp", "asc") // „Çø„Ç§„É†„Çπ„Çø„É≥„Éó„ÅÆÊòáÈ†Ü„ÅßÂèñÂæó
          .get()
          .then((snapshot) => {
            const data = [];
            const labels = [];
            snapshot.forEach((doc) => {
              const docData = doc.data();
              // „Éá„Éº„Çø„Åã„ÇâÊÑüÊÉÖ„ÅÆÊï∞ÂÄ§„ÇíÂèñÂæó„Åó„Å¶ÈÖçÂàó„Å´ËøΩÂä†
              data.push(docData.feelData);
              labels.push(docData.postDate);
            });
            return { data, labels };
          })
          .catch((error) => {
            console.error("Error getting documents: ", error);
            return { data: [], labels: [] }; // „Ç®„É©„ÉºÊôÇ„ÅØÁ©∫„ÅÆÈÖçÂàó„ÇíËøî„Åô
          });
      }

      // „Ç∞„É©„Éï‰ΩúÊàêÈñ¢Êï∞
      async function createChart() {
        const { data, labels } = await getGraphData();
        // Êó¢Â≠ò„ÅÆ„Ç∞„É©„Éï„Åå„ÅÇ„Çå„Å∞Á†¥Ê£Ñ„Åô„Çã
        if (myUpdateChart) {
          myUpdateChart.destroy();
        }
        myUpdateChart = new Chart(ctx, {
          type: "line",
          data: {
            // „Éá„Éº„Çø„ÅÆË®≠ÂÆö
            labels: Array.from({ length: data.length }, (_, i) => i + 1), // „É©„Éô„É´„ÅØÊäïÁ®ø„ÅÆÈ†ÜÁï™
            datasets: [
              {
                label: "Feelings Transition",
                data: data, // Firestore„Åã„ÇâÂèñÂæó„Åó„Åü„Éá„Éº„Çø„Çí„Çª„ÉÉ„Éà
                // „Ç∞„É©„Éï„ÅÆË®≠ÂÆö
                fill: false,
                borderColor: "#c88baa",
                tension: 0.1,
              },
            ],
          },
          options: {
            // „Ç™„Éó„Ç∑„Éß„É≥„ÅÆË®≠ÂÆö
            scales: {
              x: {
                type: "linear",
                position: "bottom",
                title: {
                  display: true,
                  text: "Date",
                },
              },
              y: {
                min: 1,
                max: 6,
                ticks: {
                  callback: function (value, index, values) {
                    // ÊÑüÊÉÖ„ÅÆÊï∞ÂÄ§„Åã„Çâ„É©„Éô„É´„ÇíÂèñÂæó
                    return [
                      "Crying",
                      "Mad",
                      "Surprised",
                      "Relax",
                      "Love",
                      "Happy",
                    ][value - 1];
                  },
                },
                title: {
                  display: true,
                  text: "Feeling",
                },
              },
            },
          },
        });
      }

      // ÂàùÊúüÂåñ
      createChart();

      // „Éá„Éº„ÇøÊõ¥Êñ∞„Éú„Çø„É≥„ÇØ„É™„ÉÉ„ÇØÊôÇ„ÅÆÂá¶ÁêÜ
      updateButton.addEventListener("click", async () => {
        // „Ç∞„É©„ÉïÂÜç‰ΩúÊàê
        await createChart();
        console.log(getGraphData());
      });
    function test(){
      let today = new Date();
      console.log(today);
      const postDate = today.getFullYear() + "/" + (today.getMonth()+1) + "/" + today.getDate() + "  " + today.getHours() + ":" + today.getMinutes();
      console.log(postDate);
    }
  </script>
</html>
