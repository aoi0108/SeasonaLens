<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <link rel="stylesheet" href="posts.css" />
    <link
      rel="stylesheet"
      href="https://unpkg.com/@vectopus/atlas-icons/style.css"
    />
    <title>Posts</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.0.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.0.0/firebase-analytics.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.0.0/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.0.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.0.0/firebase-storage.js"></script>
    <script>
      const firebaseConfig = {
        apiKey: "AIzaSyCmiBcZ3VCgEAtDMgyg0vDFhNyi7H2xcpk",
        authDomain: "seasonal-lens.firebaseapp.com",
        databaseURL: "https://seasonal-lens-default-rtdb.firebaseio.com",
        projectId: "seasonal-lens",
        storageBucket: "seasonal-lens.appspot.com",
        messagingSenderId: "961849470376",
        appId: "1:961849470376:web:cfa47d3a40d59a1116c19d",
      };
      firebase.initializeApp(firebaseConfig);
    </script>
  </head>
  <body>
    <!-- „Éè„É≥„Éê„Éº„Ç¨„Éº„É°„Éã„É•„ÉºÈÉ®ÂàÜ -->
    <div class="nav">
      <!-- „Éè„É≥„Éê„Éº„Ç¨„Éº„É°„Éã„É•„Éº„ÅÆË°®Á§∫„ÉªÈùûË°®Á§∫„ÇíÂàá„ÇäÊõø„Åà„Çã„ÉÅ„Çß„ÉÉ„ÇØ„Éú„ÉÉ„ÇØ„Çπ -->
      <input id="drawer_input" class="drawer_hidden" type="checkbox" />

      <!-- „Éè„É≥„Éê„Éº„Ç¨„Éº„Ç¢„Ç§„Ç≥„É≥ -->
      <label for="drawer_input" class="drawer_open"><span></span></label>

      <!-- „É°„Éã„É•„Éº -->
      <nav class="nav_content">
        <ul class="nav_list">
          <li class="nav_item"><a href="home.html">Home</a></li>
          <li class="nav_item"><a href="share.html">Share</a></li>
        </ul>
      </nav>
    </div>
    <!-- Êú¨Êñá -->
    <div class="PostAndArrowContainer">
      <!--„Å≤„Å†„ÇäÁü¢Âç∞ÔºàÊàª„ÇãÔºâ-->
      <botton type="button" id="leftArrow"><img src="images/arrow-left-circle.svg"  alt="previous post" ></botton>

       <div class="postContainer">
        <p id="postDay"></p>
        <img id="postPic" src="" style="height:300px;">
        <p id="feel"></p>
        <p id="caption"></p>

       </div>     
       <!--„Åø„ÅéÁü¢Âç∞ÔºàÈÄ≤„ÇÄÔºâ--> 
       <botton type="button" id="rightArrow"><img src="images/arrow-right-circle.svg"></botton>
      </div>
      <!-- „Ç∞„É©„Éï -->
      <canvas id="updateChart"></canvas>
      <!-- <div class="update-button">
        <button id="updateButton">„Éá„Éº„ÇøÊõ¥Êñ∞</button>
      </div> -->

    </div>
  </body>
  <script>
    //„Éá„Éº„Çø„Éô„Éº„Çπ„ÅÆÂèÇÁÖß„ÇíÁî®ÊÑè
    const db = firebase.firestore();
    
    //„É¶„Éº„Ç∂„Éº„ÅÆÊäïÁ®ø„Éá„Éº„Çø„Åô„Åπ„Å¶„ÇíÂèéÂÆπ„Åô„ÇãÈÖçÂàó
    let postDatas = [];
    let i = 0;

    //„Éú„Çø„É≥„ÇíÂèñÂæó
    const LButton = document.getElementById("leftArrow");
    const RButton = document.getElementById("rightArrow");

    firebase.auth().onAuthStateChanged(user => {
      if(user){
        //ÊäïÁ®ø„Éá„Éº„Çø„ÅÆÂèñÂæó
        db.collection("PostData").doc(user.uid).collection("post").get().then((snapShot) => {
          snapShot.forEach(doc => {
            postDatas[i] = doc.data();
            i++;
          });
          console.log(postDatas);
          
          //Âàá„ÇäÊõø„ÅàÁî®„ÅÆÂ§âÊï∞
          let j = 0;
          displayPost(j);

          LButton.addEventListener('click',(event)=>{
            if(j-1<0){
              j=postDatas.length-1;
            }else{
              j--;
            }
            console.log("display:"+j);
            displayPost(j);
          })

          RButton.addEventListener('click',(event)=>{
            if(j+1 > postDatas.length-1){
              j=0;
            }else{
              j++;
            }
            //console.log("display:"+j);
            displayPost(j);
          })

        });
        
        }else{
          console.log("please login.")
      }
    });

    //Âèó„ÅëÂèñ„Å£„ÅüÊï∞Â≠ó„Çí„Ç§„É≥„Éá„ÉÉ„ÇØ„Çπ„Å®„Åó„Å¶„ÄÅÂØæÂøú„Åô„ÇãÊäïÁ®ø„ÇíË°®Á§∫„Åô„ÇãÈñ¢Êï∞
    function displayPost(i){
      //ÊäïÁ®ø„ÅÆË°®Á§∫-ÂÜôÁúü„Å®„Ç≠„É£„Éó„Ç∑„Éß„É≥
      document.getElementById("postPic").src = postDatas[i].Picture;
          document.getElementById("caption").innerHTML = postDatas[i].caption;

          ////ÊäïÁ®ø„ÅÆË°®Á§∫-ÁµµÊñáÂ≠ó
          if(postDatas[i].feeling=="happy"){
            document.getElementById("feel").innerHTML = "üòÅ"
          }else if(postDatas[i].feeling=="relax"){
            document.getElementById("feel").innerHTML = "üòå"
          }else if(postDatas[i].feeling=="mad"){
            document.getElementById("feel").innerHTML = "üò°"
          }else if(postDatas[i].feeling=="crying"){
            document.getElementById("feel").innerHTML = "üò≠"
          }else if(postDatas[i].feeling=="surprised"){
            document.getElementById("feel").innerHTML = "ü§Ø"
          }else if(postDatas[i].feeling=="love"){
            document.getElementById("feel").innerHTML = "ü•∞"
          }
          //ÊäïÁ®ø„ÅÆË°®Á§∫-ÊäïÁ®øÊó•
          document.getElementById("postDay").innerHTML = postDatas[i].postDate;
    }

    let myUpdateChart; // „Ç∞„É≠„Éº„Éê„É´„Çπ„Ç≥„Éº„Éó„ÅßÂ§âÊï∞„ÇíÂÆ£Ë®Ä
      // „Ç≠„É£„É≥„Éê„Çπ„ÅÆË¶ÅÁ¥†„ÇíÂèñÂæó
      const ctx = document.getElementById("updateChart").getContext("2d");
      // const updateButton = document.getElementById("updateButton");
      // „Ç∞„É©„Éï„Éá„Éº„ÇøÂèñÂæóÈñ¢Êï∞
      function getGraphData() {
        const user = firebase.auth().currentUser;
        if (!user) {
            return Promise.resolve({ data: [], labels: [] }); // „É¶„Éº„Ç∂„Éº„Åå„É≠„Ç∞„Ç§„É≥„Åó„Å¶„ÅÑ„Å™„ÅÑÂ†¥Âêà„ÅØÁ©∫„ÅÆ„Éá„Éº„Çø„ÇíËøî„Åô
        }
        return db
          .collection("PostData")
          .doc(user.uid)
          .collection("post")
          .orderBy("timestamp", "asc") // „Çø„Ç§„É†„Çπ„Çø„É≥„Éó„ÅÆÊòáÈ†Ü„ÅßÂèñÂæó
          .get()
          .then((snapshot) => {
            const data = [];
            const labels = [];
            snapshot.forEach((doc) => {
              const docData = doc.data();
              // „Éá„Éº„Çø„Åã„ÇâÊÑüÊÉÖ„ÅÆÊï∞ÂÄ§„ÇíÂèñÂæó„Åó„Å¶ÈÖçÂàó„Å´ËøΩÂä†
              data.push(docData.feeling);
              labels.push(docData.postDate);
            });
            console.log("Data:", data); // „Éá„Éº„Çø„Çí„Ç≥„É≥„ÇΩ„Éº„É´„Å´Âá∫Âäõ
            console.log("Labels:", labels); // „É©„Éô„É´„Çí„Ç≥„É≥„ÇΩ„Éº„É´„Å´Âá∫Âäõ
            return { data, labels };
          })
          .catch((error) => {
            console.error("Error getting documents: ", error);
            return { data: [], labels: [] }; // „Ç®„É©„ÉºÊôÇ„ÅØÁ©∫„ÅÆÈÖçÂàó„ÇíËøî„Åô
          });
      }

      // „Ç∞„É©„Éï‰ΩúÊàêÈñ¢Êï∞
      async function createChart() {
        const { data, labels } = await getGraphData();
        // Êó¢Â≠ò„ÅÆ„Ç∞„É©„Éï„Åå„ÅÇ„Çå„Å∞Á†¥Ê£Ñ„Åô„Çã
        if (myUpdateChart) {
          myUpdateChart.destroy();
        }
        myUpdateChart = new Chart(ctx, {
          type: "line",
          data: {
            // „Éá„Éº„Çø„ÅÆË®≠ÂÆö
            labels: labels,
            datasets: [
              {
                label: "Feelings Transition",
                data: data, // Firestore„Åã„ÇâÂèñÂæó„Åó„Åü„Éá„Éº„Çø„Çí„Çª„ÉÉ„Éà
                // „Ç∞„É©„Éï„ÅÆË®≠ÂÆö
                fill: false,
                borderColor: "#c88baa",
                tension: 0.1,//Êäò„ÇåÁ∑ö„ÅÆ„Ç´„Éº„ÉñÁéá
              },
            ],
          },
          options: {
            // „Ç™„Éó„Ç∑„Éß„É≥„ÅÆË®≠ÂÆö
            scales: {
              x: {
                type: "linear",
                position: "bottom",
                title: {
                  display: true,
                  text: "Date",
                },
              },
              y: {
                min: 1,
                max: 6,
                ticks: {
                  callback: function (value, index, values) {
                    // ÊÑüÊÉÖ„ÅÆÊï∞ÂÄ§„Åã„Çâ„É©„Éô„É´„ÇíÂèñÂæó
                    return [
                      "üò≠",
                      "üò°",
                      "ü§Ø",
                      "üòå",
                      "ü•∞",
                      "üòÅ",
                    ][value - 1];
                  },
                },
                title: {
                  display: true,
                  text: "Feeling",
                },
              },
            },
          },
        });
      }

      // ÂàùÊúüÂåñ
      createChart();

      // // „Éá„Éº„ÇøÊõ¥Êñ∞„Éú„Çø„É≥„ÇØ„É™„ÉÉ„ÇØÊôÇ„ÅÆÂá¶ÁêÜ
      // updateButton.addEventListener("click", async () => {
      //   // „Ç∞„É©„ÉïÂÜç‰ΩúÊàê
      //   await createChart();
      //   // console.log(getGraphData());
      // });

  </script>
</html>
